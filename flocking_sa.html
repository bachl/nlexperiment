<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />



<title>Simulated Annealing</title>

<script src="libs/jquery-1.11.0/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.1/css/spacelab.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.1/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/respond.min.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<link rel="stylesheet"
      href="libs/highlight/default.css"
      type="text/css" />
<script src="libs/highlight/highlight.js"></script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>


<link rel="stylesheet" href="tufterhandout2.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img { 
  max-width:100%; 
  height: auto; 
}
</style>
<div class="container-fluid main-container">


<div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header navbar-left">
      <!--a class="navbar-brand" href="index.html">nlexperiment</a-->
      <a class="navbar-brand" href="index.html">
        <!--img class="img-responsive" src="img/logo.png"-->
        <strong><nl>nl</nl><experiment>experiment</experiment></strong>
      </a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li class="dropdown">
          <a href="tutorial" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Tutorial <span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu">
             <li><a href="tutorial.html">Overview</a></li>
             <li class="divider"></li>
             <li class="dropdown-header">Getting started</li>
             <li><a href="fire.html">Fire Experiment</a></li>
             <li><a href="agents.html">Agents and Patches</a></li>
             <li><a href="ants.html">Ants</a></li>
             <li class="divider"></li>
             <li class="dropdown-header">Parameter Sets</li>
             <li><a href="fur.html">Fur Patterns</a></li>
             <li><a href="flocking.html">Flocking</a></li>
             <li><a href="flocking_categorical.html">Categorical Criteria</a></li>
             <li><a href="flocking_sampling.html">Latin Hypercube Sampling</a></li>
             <li class="divider"></li>
             <li class="dropdown-header">Optimization</li>
             <li><a href="flocking_bestfit.html">Best-fit Criterion</a></li>
             <li><a href="flocking_random_search.html">Random Search</a></li>
             <li><a href="flocking_bfgs.html">Optimization with L-BFGS-B</a></li>
             <li><a href="flocking_sa.html">Simulated Annealing</a></li>
             <li><a href="flocking_ga.html">Genetic Algorithm</a></li>
          </ul>
        </li>
        <li><a href="help/index.html">Package documentation</a></li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
         <li><a href="https://github.com/bergant/nlexperiment">GitHub</a></li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">
<h1 class="title">Simulated Annealing</h1>
</div>


<p>This example is using NetLogo Flocking model (Wilensky, 1998) to demonstrate parameter fitting with simulated annealing.</p>
<aside>
Wilensky, U. (1998). <a href="http://ccl.northwestern.edu/netlogo/models/Flocking">NetLogo Flocking model</a>. Center for Connected Learning and Computer-Based Modeling, Northwestern University, Evanston, IL.
</aside>
<p>There are many R packages for solving optimization problems (see <a href="https://cran.rstudio.com/web/views/Optimization.html">CRAN Task View</a>). This example uses <strong>GenSA</strong> function from <code>GenSA</code> package (Xiang et al., 2013). See also Thiele, Kurth &amp; Grimm (2014) chapter <a href="http://jasss.soc.surrey.ac.uk/17/3/11.html#sectionSimAnn">2.31 Simulated annealing</a>.</p>
<aside>
<p>Yang Xiang, Sylvain Gubian, Brian Suomela, Julia Hoeng. Generalized Simulated Annealing for Global Optimization: the GenSA Package. The R Journal, Volume 5(1):13-29, June 2013. URL <a href="http://journal.r-project.org/archive/2013-1/xiang-gubian-suomela-etal.pdf" class="uri">http://journal.r-project.org/archive/2013-1/xiang-gubian-suomela-etal.pdf</a></p>
Thiele, J. C., Kurth, W., &amp; Grimm, V. (2014). Facilitating Parameter Estimation and Sensitivity Analysis of Agent-Based Models: A Cookbook Using NetLogo and R. Journal of Artificial Societies and Social Simulation, 17(3), 11. <a href="http://jasss.soc.surrey.ac.uk/17/3/11.html" class="uri">http://jasss.soc.surrey.ac.uk/17/3/11.html</a>
</aside>
<p>Experiment definition is the same as in <a href="flocking_bfgs.html">L-BFGS-B Optimization</a> example:</p>
<p><lside><span class="glyphicon glyphicon-list-alt" aria-hidden="true" title="Define the experiment" style="color:gray"></span></lside></p>
<pre class="r"><code>experiment &lt;- nl_experiment( 
  model_file = &quot;models/Sample Models/Biology/Flocking.nlogo&quot;,

  setup_commands = c(&quot;setup&quot;, &quot;repeat 100 [go]&quot;),
  iterations = 5,

  param_values = list(
    world_size = 50,
    population = 80,
    vision = 6,
    min_separation = seq(from = 0, to = 4, by = 0.5),
    max_align_turn = seq(from = 0, to = 20, by = 2.5)
  ),
  mapping = c(
    min_separation = &quot;minimum-separation&quot;,
    max_align_turn = &quot;max-align-turn&quot;),

  step_measures = measures(
    converged = &quot;1 - 
      (standard-deviation [dx] of turtles + 
       standard-deviation [dy] of turtles) / 2&quot;,
    mean_crowding = 
      &quot;mean [count flockmates + 1] of turtles&quot;
  ),
  eval_criteria = criteria(
    c_converged = mean(step$converged),
    c_mcrowding = mean(step$mean_crowding)
  ),

  repetitions = 10,                 # repeat simulations 10 times

  eval_aggregate_fun = mean,        # aggregate over repetitions

  eval_mutate = criteria(           # evaluation criterium
    eval_value = 
      sqrt((c_mcrowding - 8)^2 + 400*(c_converged - 1)^2)
  )
)</code></pre>
<p>In this example the <code>nl_eval_run</code> function is used as evaluation function instead of evaluating all parameter sets with <code>nl_run</code>.</p>
<p>Note that this kind of evaluation requires started NetLogo instance. User have to take care to initialize NetLogo and load the model before optimization begins and close NetLogo when it is no longer needed (see <code>nl_eval_run</code> in package documentation).</p>
<p><lside><span class="glyphicon glyphicon-play-circle" aria-hidden="true" title="Run SA" style="color:gray"></span></lside></p>
<pre class="r"><code>library(GenSA) 

cl &lt;- nl_eval_init(experiment, parallel = TRUE)
trace &lt;- nl_eval_tracer(verbose = FALSE)
param_range &lt;- nl_get_param_range(experiment)   
set.seed(42) 

result &lt;- GenSA(
  par = param_range$upper,

  fn = nl_eval_run, 
    experiment = experiment, 
    criteria = &quot;eval_value&quot;, 
    call_back = trace$add, 
    parallel = TRUE, cluster = cl,
    param_names = names(param_range$lower),

  control=list(max.time = 60*5), # let it run for 5 minutes
  lower = param_range$lower,
  upper = param_range$upper
)

nl_eval_close(parallel = TRUE, cl)</code></pre>
<aside>
See <a href="http://www.inside-r.org/packages/cran/GenSA/docs/GenSA">GenSA package documentation</a> for more information about GenSA.
</aside>
<p><lside><span class="glyphicon glyphicon-stats" aria-hidden="true" title="Plot evaluation progress" style="color:gray"></span></lside></p>
<pre class="r"><code>library(ggplot2) 
dat &lt;- as.data.frame(result$trace.mat)
ggplot(dat, aes(x = nb.steps, y =current.minimum)) +
  geom_point(data = dat, 
             aes(x = nb.steps, y = function.value), 
             position = position_jitter(height = 0, width = 0.05),
             alpha = 0.5)+
  geom_step(alpha = 0.3) +
  theme_minimal() +
  ylab(&quot;Values, current minimum&quot;)</code></pre>
<p>
<img src="img/pages-flockSAPlot1-1.png">
<aside>
<p class="caption">
Simulated annealing progress
</p>
</aside>
</p>
<p><lside><span class="glyphicon glyphicon-th-list" aria-hidden="true" title="Result" style="color:gray"></span></lside></p>
<pre class="r"><code>final &lt;- setNames(data.frame(t(result$par)), names(param_range$lower))
final$result &lt;- result$value
htmlTable::htmlTable(round(final,1))</code></pre>
<table class="gmisc_table" style="border-collapse: collapse;">
<thead>
<tr>
<th style="border-bottom: 1px solid grey; border-top: 2px solid grey;">
</th>
<th style="border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;">
min_separation
</th>
<th style="border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;">
max_align_turn
</th>
<th style="border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;">
result
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="border-bottom: 2px solid grey; text-align: left;">
1
</td>
<td style="border-bottom: 2px solid grey; text-align: center;">
1.9
</td>
<td style="border-bottom: 2px solid grey; text-align: center;">
15.3
</td>
<td style="border-bottom: 2px solid grey; text-align: center;">
4.1
</td>
</tr>
</tbody>
</table>
<p><lside><span class="glyphicon glyphicon-stats" aria-hidden="true" title="Plot results" style="color:gray"></span></lside></p>
<pre class="r"><code>dat &lt;- trace$get()
ggplot(dat, aes(x = min_separation, y = max_align_turn, color = result)) +
  geom_point(size = 3, alpha = 0.8) +
  geom_point(data = final , size = 10, shape = 8, color = &quot;red&quot;) +
  theme_minimal() +
  #theme(legend.position = &quot;none&quot;) +
  coord_fixed(4/20)</code></pre>
<p>
<img src="img/pages-flockSAPlot2-1.png">
<aside>
<p class="caption">
All traced evaluations in parameter space. Best result marked with asterisk
</p>
</aside>
</p>
<div id="related" class="section level2">
<h2>Related</h2>
<p><a href="flocking_ga.html">Genetic Algorithm</a> demonstrates optimization with genetic algorithm.</p>
<p><a href="flocking_bfgs.html">L-BFGS-B Optimization</a> shows how to use optimization functions from other R packages.</p>
<p><a href="flocking_random_search.html">Random Search</a> demonstrates searching for optimal parameters using random search.</p>
<p><asideclose> Get <a href="flocking_sa.rmd">rmarkdown source</a> of this page. </asideclose></p>
</div>


<footer>
  <a href="about.html">About</a> |
  View project on <a href="https://github.com/bergant/nlexperiment">GitHub</a> |
  Report <a href="https://github.com/bergant/nlexperiment/issues">Issues</a>
</footer>

</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
