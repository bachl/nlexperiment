---
output: 
  html_document: 
    keep_md: yes
    self_contained: no
---

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "img/README-"
)
```


```{r, echo = FALSE}
library(nlexperiment)
# Set the path to your NetLogo instalation
nl_netlogo_path("c:/Program Files (x86)/NetLogo 5.2.0") 
library(ggplot2)
```


## Parameter space mapping
The following example is using NetLogo Fur model (Wilensky 2003) to show 
explicit definition of parameter sets and parameter mapping.

There are 5 parameters in the NetLogo Fur model: 

* `ratio` 
* `outer-radius-y`
* `inner-radius-y`
* `outer-radius-x`
* `inner-radius-x`

But considering constraints and model symmetry
we can reduce it only to ratio and ellipse aspect ratio. It is sufficient to
create parameter sets based on combinations of

* `ratio` (the inhibitor concentration parameter)
* `radius_diff` (the difference between x and y radius) and
* `gap` (distance between inner and outer ellipse)

(for simplicity let's keep the `gap` between the circles constant):


```{r p7experiment}
experiment <- nl_experiment( 
  model_file = file.path(nl_netlogo_path(), 
                         "models/Sample Models/Biology/Fur.nlogo"), 
  iterations = 20,                                     

  param_values = {                                  # Parameter sets:
    param_sets <- expand.grid(                      #   all combinations of
        gap = 3,                                    #   gap, ratio and ry- rx
        radius_diff = seq(0, 2, by = 0.5), 
        ratio = seq(0.30, 0.65, by = 0.05)
    )
    transform(param_sets,                           # Transform to NetLogo
      inner_radius_x = 3,                           #   variables
      outer_radius_x = 3 + gap,
      inner_radius_y = 3 + radius_diff,
      outer_radius_y = 3 + radius_diff + gap
    )
  },
  mapping = c(
    gap = "",
    radius_diff = "",
    inner_radius_x = "inner-radius-x",
    outer_radius_x = "outer-radius-x",
    inner_radius_y = "inner-radius-y",
    outer_radius_y = "outer-radius-y"
  ),  
  export_view = TRUE,
  random_seed = 3
)
```

_Note:_ 

* _Element `param_values` is set by a data frame with explicit parameter sets_ 
* _Variables `gap` and `radius_diff` must be mapped to empty string (not NetLogo variables)._


Run experiment
```{r p7RunModel, cache=TRUE}
result <- nl_run(experiment, parallel = TRUE, max_cores = 3)   
```

Show resulting fur patterns:
```{r p7ShowViews}
library(ggplot2)
nl_show_views_grid(
  result, x_param = "ratio", y_param = "radius_diff", img_gap = 0.01) + 
  ylab("radius_y - radius_x") +
  ggtitle("Fur patterns")
```


